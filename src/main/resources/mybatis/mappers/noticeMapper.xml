<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="noticeMapper">

    <resultMap id="noticeResultMap" type="com.cl.cruella.dto.NoticeDto">
        <result column="notice_no" property="noticeNo" />
        <result column="notice_title" property="noticeTitle" />
        <result column="notice_content" property="noticeContent" />
        <result column="mem_no" property="memNo" />
        <result column="notice_count" property="noticeCount" />
        <result column="attach_count" property="attachCount" />
        <result column="notice_regist_date" property="noticeRegistDT" />
        <result column="notice_modify_date" property="noticeModifyDT" />
        <result column="notice_status" property="noticeStatus" />
        <result column="dept_code" property="deptCode" />
        <result column="mem_name" property="memName" />
        <collection resultMap="attachResultMap" property="attachList" />
    </resultMap>
    
    <resultMap id="attachResultMap" type="com.cl.cruella.dto.AttachDto">
        <result column="file_no" property="fileNo"/>
        <result column="file_path" property="filePath"/>
        <result column="file_system_name" property="filesystemName"/>
        <result column="file_original_name" property="originalName"/>
        <result column="file_upload_date" property="uploadDt"/>
        <result column="file_ref_type" property="refType"/>
        <result column="file_ref_no" property="refNo"/>
    </resultMap>
  
		<select id="selectNoticeListCount" parameterType="string" resultType="int">
		  SELECT COUNT(*)
		  FROM notice
		  WHERE dept_code IS NULL OR dept_code = #{deptCode}
		</select>
		
		<select id="selectNoticeList" parameterType="map" resultMap="noticeResultMap">
		  SELECT
		      n.notice_no,
		      n.notice_title,
		      n.notice_content,
		      m.mem_no,
		      m.mem_name,
		      n.notice_count,
		      TO_CHAR(n.notice_regist_date, 'YYYY-MM-DD') AS notice_regist_date,
		      TO_CHAR(n.notice_modify_date, 'YYYY-MM-DD') AS notice_modify_date,
		      n.notice_status,
		      n.dept_code,
		      COALESCE(a.attach_count, 0) AS attach_count
		  FROM notice n
		  JOIN member m ON (m.mem_no = n.mem_no)
		  LEFT JOIN (
		      SELECT file_ref_no, COUNT(*) AS attach_count
		      FROM attachment
		      WHERE file_ref_type = 'N'
		      GROUP BY file_ref_no
		  ) a ON a.file_ref_no = n.notice_no
		  WHERE n.notice_status = 'Y'
		    AND (n.dept_code IS NULL OR n.dept_code = #{deptCode})
		  ORDER BY n.notice_no DESC
		</select>
		
		<select id="selectSearchListCount" resultType="int" parameterType="map">
		  SELECT COUNT(*)
		  FROM notice n
		  JOIN member m ON (m.mem_no = n.mem_no)
		  WHERE n.notice_status = 'Y'
		    AND (n.dept_code IS NULL OR n.dept_code = #{deptCode})
		  <if test="condition == ''">
		    AND (m.mem_name LIKE '%' || #{keyword} || '%' OR n.notice_title LIKE '%' || #{keyword} || '%' OR n.notice_content LIKE '%' || #{keyword} || '%')
		  </if>
		  <if test="condition != ''">
		    <if test="condition == 'mem_name'">
		      AND m.mem_name LIKE '%' || #{keyword} || '%'
		    </if>
		    <if test="condition == 'notice_title'">
		      AND n.notice_title LIKE '%' || #{keyword} || '%'
		    </if>
		    <if test="condition == 'notice_content'">
		      AND n.notice_content LIKE '%' || #{keyword} || '%'
		    </if>
		  </if>
		</select>
		
		<select id="selectSearchList" resultMap="noticeResultMap" parameterType="map">
		  SELECT
		      n.notice_no,
		      n.notice_title,
		      n.notice_content,
		      m.mem_no,
		      m.mem_name,
		      n.notice_count,
		      TO_CHAR(n.notice_regist_date, 'YYYY-MM-DD') AS notice_regist_date,
		      TO_CHAR(n.notice_modify_date, 'YYYY-MM-DD') AS notice_modify_date,
		      n.notice_status,
		      n.dept_code,
		      COALESCE(a.attach_count, 0) AS attach_count
		  FROM notice n
		  JOIN member m ON (m.mem_no = n.mem_no)
		  LEFT JOIN (
		      SELECT file_ref_no, COUNT(*) AS attach_count
		      FROM attachment
		      WHERE file_ref_type = 'N'
		      GROUP BY file_ref_no
		  ) a ON a.file_ref_no = n.notice_no
		  WHERE n.notice_status = 'Y'
		    AND (n.dept_code IS NULL OR n.dept_code = #{deptCode})
		  <if test="condition == ''">
		    AND (m.mem_name LIKE '%' || #{keyword} || '%' OR n.notice_title LIKE '%' || #{keyword} || '%' OR n.notice_content LIKE '%' || #{keyword} || '%')
		  </if>
		  <if test="condition != ''">
		    <if test="condition == 'mem_name'">
		      AND m.mem_name LIKE '%' || #{keyword} || '%'
		    </if>
		    <if test="condition == 'notice_title'">
		      AND n.notice_title LIKE '%' || #{keyword} || '%'
		    </if>
		    <if test="condition == 'notice_content'">
		      AND n.notice_content LIKE '%' || #{keyword} || '%'
		    </if>
		  </if>
		  ORDER BY n.notice_no DESC
		</select>

		<select id="selectNotice" resultMap="noticeResultMap">
		  SELECT
		      n.notice_no,
		      n.notice_title,
		      n.notice_content,
		      m.mem_no,
		      m.mem_name,
		      TO_CHAR(n.notice_regist_date, 'YYYY-MM-DD') AS notice_regist_date,
		      TO_CHAR(n.notice_modify_date, 'YYYY-MM-DD') AS notice_modify_date,
		      n.notice_count,
		      n.dept_code,
		      a.file_no,
		      a.file_path,
		      a.file_system_name,
		      a.file_original_name,
		      (
		          SELECT COUNT(*)
		          FROM attachment
		          WHERE file_ref_type = 'N'
		            AND file_ref_no = n.notice_no
		      ) AS attach_count
		  FROM notice n
		  JOIN member m ON (m.mem_no = n.mem_no)
		  LEFT JOIN attachment a ON (a.file_ref_type = 'N' AND a.file_ref_no = n.notice_no)
		  WHERE n.notice_status = 'Y'
		    AND (n.dept_code IS NULL OR n.dept_code = #{deptCode})
		    AND n.notice_no = #{noticeNo}
		</select>
		

		
    <insert id="insertNotice">
        insert into notice
          (
            notice_no
          , notice_title
          , mem_no
          , notice_content
          , notice_regist_date
          , notice_modify_date
          , notice_status
          , dept_code
          )
          values
          (
            seq_bno.nextval
          , #{noticeTitle}
          , #{memNo}
          , #{noticeContent}
          , SYSDATE
          , SYSDATE
          , 'Y'
          , #{deptCode}
          )
    </insert>

    <insert id="insertAttach">
        insert into attachment
          (
            file_no
          , file_path
          , file_system_name
          , file_original_name
          , file_ref_type
          , file_ref_no
          )
          values
          (
            seq_fno.nextval
          , #{filePath}
          , #{filesystemName}
          , #{originalName}
          , #{refType}
          <choose>
              <when test="refNo == 0">
                  , seq_bno.currval
              </when>
              <otherwise>
                  , #{refNo}
              </otherwise>
          </choose>
          )
    </insert>  

    <update id="updateIncreaseCount">
        update notice
           set notice_count = notice_count + 1
         where notice_no = #{noticeNo}
           and notice_status = 'Y'
    </update>

		<select id="selectDelAttach" resultMap="attachResultMap">
			select
						 file_path
					 , file_system_name
			  from attachment 
			<where>
			  <foreach item="no" collection="array"
			  	open="file_no in (" separator="," close=")">
			  	#{no}
			  </foreach>
			</where>
		</select>
		
		<update id="updatenotice">
		    UPDATE notice
		    SET notice_title = #{noticeTitle},
		        notice_content = #{noticeContent},
		        notice_modify_date = SYSDATE
		    WHERE notice_no = #{noticeNo}
		</update>
		
		<delete id="deleteAttach">
			delete
			  from attachment
			 <where>
			  <foreach item="no" collection="array"
			  	open="file_no in (" separator="," close=")">
			  	#{no}
			  </foreach>
			</where> 
		</delete>

		<delete id="deleteNotice">
		    delete from notice
		    where notice_no = #{noticeNo}
		</delete>
		
		<delete id="deleteSelectNotice">
		    delete from notice
		    where notice_no in
		    <foreach item="noticeNo" collection="noticeNos" open="(" separator="," close=")">
		        #{noticeNo}
		    </foreach>
		</delete>

</mapper>





