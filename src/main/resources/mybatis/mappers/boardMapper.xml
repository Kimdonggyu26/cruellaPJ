<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="boardMapper">

    <resultMap id="boardResultMap" type="com.cl.cruella.dto.BoardDto">
        <result column="board_no" property="boardNo" />
        <result column="board_title" property="boardTitle" />
        <result column="board_content" property="boardContent" />
        <result column="mem_no" property="memNo" />
        <result column="board_count" property="boardCount" />
        <result column="board_regist_date" property="boardRegistDT" />
        <result column="board_modify_date" property="boardModifyDT" />
        <result column="board_status" property="boardStatus" />
        <result column="dept_code" property="deptCode" />
        <result column="mem_name" property="memName" />
        <collection resultMap="attachResultMap" property="attachList" />
    </resultMap>
    
    <resultMap id="attachResultMap" type="com.cl.cruella.dto.AttachDto">
        <result column="file_no" property="fileNo"/>
        <result column="file_path" property="filePath"/>
        <result column="file_system_name" property="filesystemName"/>
        <result column="file_original_name" property="originalName"/>
        <result column="file_upload_date" property="uploadDt"/>
        <result column="file_ref_type" property="refType"/>
        <result column="file_ref_no" property="refNo"/>
    </resultMap>
    
    <select id="selectBoardListCount" parameterType="string" resultType="int">
		    SELECT COUNT(*)
		    FROM board
		    WHERE dept_code = #{deptCode}
		</select>
		
		<select id="selectBoardList" parameterType="map" resultMap="boardResultMap">
		    select
		           b.board_no
		         , b.board_title
		         , b.board_content
		         , m.mem_no
		         , m.mem_name
		         , b.board_count
		         , to_char(b.board_regist_date, 'YYYY-MM-DD') as board_regist_date
		         , to_char(b.board_modify_date, 'YYYY-MM-DD') as board_modify_date
		         , b.board_status
		         , b.dept_code
		         , (
		             select count(*)
		               from attachment
		              where file_ref_type = 'B'
		                and file_ref_no = b.board_no
		           ) as attachCount
		      from board b
		      join member m on (m.mem_no = b.mem_no)
		     where b.board_status = 'Y'
		       and b.dept_code = #{deptCode}
		     order by b.board_no desc
		</select>


    <select id="selectSearchListCount" resultType="int">
        select count(*)
        from board b
        join member m on (m.mem_no = b.board_writer)
        where b.board_status = 'Y'
          and ${condition} like '%' || #{keyword} || '%'
    </select>

    <select id="selectSearchList" resultMap="boardResultMap">
        select
               b.board_no
             , b.board_title
             , b.board_content
             , m.mem_no
             , b.board_count
             , to_char(b.board_regist_date, 'YYYY-MM-DD') as board_regist_date
             , to_char(b.board_modify_date, 'YYYY-MM-DD') as board_modify_date
             , b.board_status
             , b.dept_code
             , (
                 select count(*)
                   from attachment
                  where file_ref_type = 'B'
                    and file_ref_no = b.board_no
               ) as attach_count
          from board b
          join member m on (m.mem_no = b.mem_no)
         where b.board_status = 'Y'
           and ${condition} like '%' || #{keyword} || '%'
         order by b.board_no desc
    </select>

    <insert id="insertBoard">
        insert into board
          (
            board_no
          , board_title
          , mem_no
          , board_content
          , board_regist_date
          , board_modify_date
          , board_status
          , dept_code
          )
          values
          (
            seq_bno.nextval
          , #{boardTitle}
          , #{memNo}
          , #{boardContent}
          , #{boardRegistDT}
          , #{boardModifyDT}
          , #{boardStatus}
          , #{deptCode}
          )
    </insert>

    <insert id="insertAttach">
        insert into attachment
          (
            file_no
          , file_path
          , file_system_name
          , file_original_name
          , file_ref_type
          , file_ref_no
          )
          values
          (
            seq_ano.nextval
          , #{filePath}
          , #{filesystemName}
          , #{originalName}
          , #{refType}
          <choose>
              <when test="refNo == 0">
                  , seq_bno.currval
              </when>
              <otherwise>
                  , #{refNo}
              </otherwise>
          </choose>
          )
    </insert>

    <select id="selectBoard" resultMap="boardResultMap">
        select
				       b.board_no
				     , b.board_title
				     , b.board_content
				     , m.mem_no
				     , m.mem_name
				     , to_char(b.board_regist_date, 'YYYY-MM-DD') as board_regist_date
				     , to_char(b.board_modify_date, 'YYYY-MM-DD') as board_modify_date
				     , b.board_count
				     , b.dept_code
				     , a.file_no
				     , a.file_path
				     , a.file_system_name
				     , a.file_original_name
				  from board b
				  join member m on (m.mem_no = b.mem_no)
				  left join attachment a on (a.file_ref_type = 'B' and a.file_ref_no = b.board_no)
				 where b.board_status = 'Y'
				   and b.board_no = #{boardNo}
    </select>

    <update id="updateIncreaseCount">
        update board
           set board_count = board_count + 1
         where board_no = #{boardNo}
           and board_status = 'Y'
    </update>

</mapper>





